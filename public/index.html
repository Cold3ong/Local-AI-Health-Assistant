<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Health AI Assistant</title>
  <script src="./_sdk/data_sdk.js"></script>
  <script src="./_sdk/element_sdk.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #14b8a6 0%, #0891b2 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .app-wrapper {
      width: 100%;
      max-width: 1200px;
      height: 90%;
      max-height: 800px;
      display: flex;
      gap: 0;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      border-radius: 20px;
      overflow: hidden;
    }

    .sidebar {
      width: 220px;
      background: #ffffff;
      display: flex;
      flex-direction: column;
      border-right: 2px solid #e0e0e0;
      transition: width 0.3s ease, margin-left 0.3s ease;
      position: relative;
    }

    .sidebar.collapsed {
      width: 60px;
    }

    .sidebar-toggle {
      position: absolute;
      right: -15px;
      top: 50%;
      transform: translateY(-50%);
      width: 30px;
      height: 60px;
      background: #14b8a6;
      border: none;
      border-radius: 0 8px 8px 0;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #ffffff;
      font-size: 18px;
      z-index: 10;
      transition: all 0.3s;
      box-shadow: 2px 0 8px rgba(0, 0, 0, 0.1);
    }

    .sidebar-toggle:hover {
      background: #0d9488;
      right: -16px;
    }

    .sidebar-header {
      padding: 24px 20px;
      background: #14b8a6;
      color: #ffffff;
      font-weight: 700;
      font-size: 18px;
      text-align: center;
      transition: opacity 0.3s;
    }

    .sidebar.collapsed .sidebar-header {
      opacity: 0;
      pointer-events: none;
    }

    .sidebar-nav {
      flex: 1;
      padding: 20px 0;
    }

    .nav-button {
      width: 100%;
      padding: 16px 20px;
      background: transparent;
      border: none;
      text-align: left;
      font-size: 15px;
      color: #333333;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 12px;
      font-family: inherit;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
    }

    .nav-button:hover {
      background: #f0fdfa;
    }

    .nav-button.active {
      background: #14b8a6;
      color: #ffffff;
      border-left: 4px solid #0d9488;
    }

    .nav-button .icon {
      font-size: 20px;
      width: 24px;
      text-align: center;
      flex-shrink: 0;
    }

    .nav-button span:not(.icon) {
      transition: opacity 0.3s;
    }

    .sidebar.collapsed .nav-button span:not(.icon) {
      opacity: 0;
    }

    .sidebar.collapsed .nav-button {
      justify-content: center;
      padding: 16px 10px;
    }

    .container {
      flex: 1;
      background: #ffffff;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .header {
      background: #14b8a6;
      color: #ffffff;
      padding: 24px;
      text-align: center;
    }

    .header h1 {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .header p {
      font-size: 14px;
      opacity: 0.95;
    }

    .page {
      display: none;
      flex-direction: column;
      height: 100%;
    }

    .page.active {
      display: flex;
    }

    /* Chat room sidebar */
    .chat-page-wrapper {
      display: flex;
      height: 100%;
    }

    .chat-rooms-sidebar {
      width: 240px;
      background: #fafafa;
      border-right: 1px solid #e0e0e0;
      display: flex;
      flex-direction: column;
    }

    .chat-rooms-header {
      padding: 16px;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .chat-rooms-header h3 {
      font-size: 16px;
      color: #333333;
      font-weight: 600;
    }

    .new-room-btn {
      background: #14b8a6;
      color: #ffffff;
      border: none;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.3s;
      font-family: inherit;
    }

    .new-room-btn:hover {
      background: #0d9488;
    }

    .chat-rooms-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }

    .chat-room-item {
      padding: 12px 14px;
      margin-bottom: 4px;
      background: transparent;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      width: 100%;
      text-align: left;
      font-family: inherit;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .chat-room-item:hover {
      background: #f0f0f0;
    }

    .chat-room-item.active {
      background: #14b8a6;
      color: #ffffff;
    }

    .chat-room-name {
      font-size: 14px;
      font-weight: 500;
      color: #333333;
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .chat-room-item.active .chat-room-name {
      color: #ffffff;
    }

    .delete-room-btn {
      background: transparent;
      border: none;
      color: #999999;
      cursor: pointer;
      font-size: 16px;
      padding: 4px;
      opacity: 0;
      transition: all 0.3s;
    }

    .chat-room-item:hover .delete-room-btn {
      opacity: 1;
    }

    .chat-room-item.active .delete-room-btn {
      color: #ffffff;
      opacity: 1;
    }

    .delete-room-btn:hover {
      color: #ef5350;
    }

    .chat-room-item.active .delete-room-btn:hover {
      color: #ffebee;
    }

    .new-room-form {
      padding: 12px;
      border-bottom: 1px solid #e0e0e0;
      background: #ffffff;
    }

    .new-room-input {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      margin-bottom: 8px;
      outline: none;
    }

    .new-room-input:focus {
      border-color: #14b8a6;
    }

    .new-room-actions {
      display: flex;
      gap: 8px;
    }

    .new-room-actions button {
      flex: 1;
      padding: 8px;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      font-family: inherit;
    }

    .create-room-btn {
      background: #14b8a6;
      color: #ffffff;
    }

    .create-room-btn:hover {
      background: #0d9488;
    }

    .cancel-room-btn {
      background: #e0e0e0;
      color: #333333;
    }

    .cancel-room-btn:hover {
      background: #d0d0d0;
    }

    .chat-main-area {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .chat-area {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      background: #f8f9fa;
    }

    .saved-area {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      background: #f8f9fa;
    }

    .saved-section {
      margin-bottom: 32px;
    }

    .saved-section h2 {
      font-size: 22px;
      color: #333333;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .saved-card {
      background: #ffffff;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .saved-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .saved-card-title {
      font-weight: 600;
      color: #14b8a6;
      font-size: 16px;
    }

    .saved-card-date {
      font-size: 13px;
      color: #999999;
    }

    .delete-button {
      padding: 8px 16px;
      background: #ef5350;
      color: #ffffff;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      cursor: pointer;
      transition: background 0.3s;
      font-family: inherit;
      font-weight: 500;
    }

    .delete-button:hover {
      background: #e53935;
    }

    .delete-button:disabled {
      background: #cccccc;
      cursor: not-allowed;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999999;
    }

    .empty-state .icon {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-state p {
      font-size: 16px;
    }

    .message {
      margin-bottom: 16px;
      display: flex;
      gap: 12px;
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message.user {
      flex-direction: row-reverse;
    }

    .message-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      flex-shrink: 0;
    }

    .message.ai .message-avatar {
      background: #14b8a6;
      color: #ffffff;
    }

    .message.user .message-avatar {
      background: #0891b2;
      color: #ffffff;
    }

    .message-content {
      max-width: 70%;
      padding: 12px 16px;
      border-radius: 16px;
      line-height: 1.5;
      font-size: 15px;
    }

    .message.ai .message-content {
      background: #ffffff;
      color: #333333;
      border: 1px solid #e0e0e0;
    }

    .message.user .message-content {
      background: #14b8a6;
      color: #ffffff;
    }

    .schedule-table, .diet-table {
      margin-top: 12px;
      width: 100%;
      background: #ffffff;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid #e0e0e0;
    }

    .table-header {
      background: #14b8a6;
      color: #ffffff;
      padding: 12px;
      font-weight: 600;
      text-align: center;
      font-size: 16px;
    }

    .table-row {
      display: flex;
      padding: 12px;
      border-bottom: 1px solid #e0e0e0;
      gap: 12px;
    }

    .table-row:last-child {
      border-bottom: none;
    }

    .table-row .time {
      font-weight: 600;
      color: #14b8a6;
      min-width: 80px;
    }

    .table-row .activity {
      flex: 1;
      color: #333333;
    }

    .save-button {
      margin-top: 12px;
      padding: 10px 20px;
      background: #4caf50;
      color: #ffffff;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
      font-family: inherit;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .save-button:hover {
      background: #43a047;
    }

    .save-button:disabled {
      background: #cccccc;
      cursor: not-allowed;
    }

    .save-button.saved {
      background: #999999;
      cursor: default;
    }

    .disclaimer {
      background: #fff3cd;
      border: 1px solid #ffc107;
      color: #856404;
      padding: 12px;
      border-radius: 8px;
      margin-top: 12px;
      font-size: 13px;
    }

    .input-area {
      padding: 20px 24px;
      background: #ffffff;
      border-top: 1px solid #e0e0e0;
    }

    .input-form {
      display: flex;
      gap: 12px;
    }

    .input-form input {
      flex: 1;
      padding: 14px 18px;
      border: 2px solid #e0e0e0;
      border-radius: 25px;
      font-size: 15px;
      outline: none;
      transition: border-color 0.3s;
      font-family: inherit;
    }

    .input-form input:focus {
      border-color: #14b8a6;
    }

    .input-form button {
      padding: 14px 28px;
      background: #14b8a6;
      color: #ffffff;
      border: none;
      border-radius: 25px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s;
      font-family: inherit;
    }

    .input-form button:hover {
      background: #0d9488;
    }

    .input-form button:disabled {
      background: #cccccc;
      cursor: not-allowed;
    }

    .loading-indicator {
      display: none;
      align-items: center;
      gap: 8px;
      color: #14b8a6;
      font-size: 14px;
      padding: 12px 0;
    }

    .loading-indicator.active {
      display: flex;
    }

    .loading-dots {
      display: flex;
      gap: 4px;
    }

    .loading-dots span {
      width: 8px;
      height: 8px;
      background: #14b8a6;
      border-radius: 50%;
      animation: bounce 1.4s infinite ease-in-out;
    }

    .loading-dots span:nth-child(1) {
      animation-delay: -0.32s;
    }

    .loading-dots span:nth-child(2) {
      animation-delay: -0.16s;
    }

    @keyframes bounce {
      0%, 80%, 100% {
        transform: scale(0);
      }
      40% {
        transform: scale(1);
      }
    }

    @media (max-width: 768px) {
      .app-wrapper {
        height: 100%;
        max-height: 100%;
        border-radius: 0;
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
        flex-direction: row;
        border-right: none;
        border-bottom: 2px solid #e0e0e0;
      }

      .sidebar-header {
        display: none;
      }

      .sidebar-nav {
        display: flex;
        flex: 1;
        padding: 0;
      }

      .nav-button {
        flex: 1;
        justify-content: center;
        padding: 12px;
        border-left: none;
      }

      .nav-button.active {
        border-left: none;
        border-bottom: 4px solid #764ba2;
      }

      .chat-rooms-sidebar {
        display: none;
      }

      .message-content {
        max-width: 85%;
      }

      .header h1 {
        font-size: 24px;
      }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body>
  <div class="app-wrapper">
   <aside class="sidebar" id="sidebar"><button class="sidebar-toggle" id="sidebar-toggle" aria-label="Toggle sidebar"> ‚óÄ </button>
    <div class="sidebar-header">
     Menu
    </div>
    <nav class="sidebar-nav"><button class="nav-button active" data-page="chat"> <span class="icon">üí¨</span> <span>Chat</span> </button> <button class="nav-button" data-page="schedule"> <span class="icon">üèãÔ∏è</span> <span>My Schedule</span> </button> <button class="nav-button" data-page="diet"> <span class="icon">ü•ó</span> <span>My Diet</span> </button>
    </nav>
   </aside>
   <div class="container">
    <header class="header">
     <h1 id="app-title">Health AI Assistant</h1>
     <p id="welcome-message">Ask me anything about health, fitness, or nutrition!</p>
    </header><!-- Content Area Container -->
    <div style="flex: 1; display: flex; flex-direction: column; overflow: hidden;"><!-- Chat Page with Room Sidebar -->
     <div id="page-chat" class="page active">
      <div class="chat-page-wrapper"><!-- Chat Rooms Sidebar -->
       <div class="chat-rooms-sidebar">
        <div class="chat-rooms-header">
         <h3>Chat Rooms</h3><button class="new-room-btn" id="new-room-btn" title="New Chat Room">+</button>
        </div>
        <div class="new-room-form" id="new-room-form" style="display: none;"><input type="text" class="new-room-input" id="new-room-input" placeholder="Enter room name..." maxlength="30">
         <div class="new-room-actions"><button class="create-room-btn" id="create-room-btn">Create</button> <button class="cancel-room-btn" id="cancel-room-btn">Cancel</button>
         </div>
        </div>
        <div class="chat-rooms-list" id="chat-rooms-list"><!-- Chat rooms will be rendered here -->
        </div>
       </div><!-- Chat Main Area -->
       <div class="chat-main-area">
        <div class="chat-area" id="chat-area">
         <div class="message ai">
          <div class="message-avatar">
           üè•
          </div>
          <div class="message-content">
           <div>
            Hello! I'm your health assistant. I can help you with:
           </div>
           <div style="margin-top: 8px;">
            ‚Ä¢ Health and wellness questions<br>
             ‚Ä¢ Creating workout schedules<br>
             ‚Ä¢ Planning diet timetables
           </div>
           <div class="disclaimer" id="disclaimer"><strong>‚ö†Ô∏è Disclaimer:</strong> <span id="disclaimer-text">I provide general health information only. Always consult qualified healthcare professionals for medical advice, diagnosis, or treatment.</span>
           </div>
          </div>
         </div>
        </div>
       </div>
      </div>
     </div><!-- My Schedule Page -->
     <div id="page-schedule" class="page">
      <div class="saved-area" id="schedule-area">
       <div class="saved-section">
        <h2><span>üèãÔ∏è</span> My Workout Schedules</h2>
        <div id="schedule-list"></div>
       </div>
      </div>
     </div><!-- My Diet Page -->
     <div id="page-diet" class="page">
      <div class="saved-area" id="diet-area">
       <div class="saved-section">
        <h2><span>ü•ó</span> My Diet Plans</h2>
        <div id="diet-list"></div>
       </div>
      </div>
     </div>
    </div><!-- Input Area - Only visible on Chat page -->
    <div class="input-area" id="input-area">
     <div class="loading-indicator" id="loading-indicator">
      <div class="loading-dots"><span></span> <span></span> <span></span>
      </div><span>AI is thinking...</span>
     </div>
     <form class="input-form" id="message-form"><input type="text" id="message-input" placeholder="Ask about health, request a workout schedule, or diet plan..." autocomplete="off"> <button type="submit" id="send-button">Send</button>
     </form>
    </div>
   </div>
  </div>
  <script>
    const defaultConfig = {
      app_title: "Health AI Assistant",
      welcome_message: "Ask me anything about health, fitness, or nutrition!",
      disclaimer_text: "I provide general health information only. Always consult qualified healthcare professionals for medical advice, diagnosis, or treatment.",
      primary_color: "#14b8a6",
      secondary_color: "#0891b2",
      background_color: "#f8f9fa",
      text_color: "#333333",
      white_color: "#ffffff"
    };

    let messages = [];
    let chatRooms = [];
    let currentRoomId = 'default';
    let isProcessing = false;
    let currentPage = 'chat';

    // Data SDK Handler
    const dataHandler = {
      onDataChanged(data) {
        messages = data.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
        
        // Extract unique chat rooms
        const roomsMap = new Map();
        messages.forEach(msg => {
          if (msg.roomId && msg.roomName && !roomsMap.has(msg.roomId)) {
            roomsMap.set(msg.roomId, msg.roomName);
          }
        });
        
        chatRooms = Array.from(roomsMap, ([id, name]) => ({ id, name }));
        
        // Ensure default room exists
        if (!chatRooms.find(r => r.id === 'default')) {
          chatRooms.unshift({ id: 'default', name: 'General Health' });
        }
        
        renderChatRooms();
        renderMessages();
        renderSavedSchedules();
        renderSavedDiets();
      }
    };

    // Initialize Data SDK
    async function initDataSdk() {
      const result = await window.dataSdk.init(dataHandler);
      if (!result.isOk) {
        console.error("Failed to initialize Data SDK");
      }
    }

    // Element SDK functions
    async function onConfigChange(config) {
      const appTitle = config.app_title || defaultConfig.app_title;
      const welcomeMessage = config.welcome_message || defaultConfig.welcome_message;
      const disclaimerText = config.disclaimer_text || defaultConfig.disclaimer_text;
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      const secondaryColor = config.secondary_color || defaultConfig.secondary_color;
      const backgroundColor = config.background_color || defaultConfig.background_color;

      document.getElementById('app-title').textContent = appTitle;
      document.getElementById('welcome-message').textContent = welcomeMessage;
      document.getElementById('disclaimer-text').textContent = disclaimerText;

      // Apply colors
      document.body.style.background = `linear-gradient(135deg, ${primaryColor} 0%, ${secondaryColor} 100%)`;
      document.querySelector('.header').style.background = primaryColor;
      
      const chatAreas = document.querySelectorAll('.chat-area, .saved-area');
      chatAreas.forEach(area => area.style.background = backgroundColor);
      
      const aiAvatars = document.querySelectorAll('.message.ai .message-avatar');
      aiAvatars.forEach(avatar => avatar.style.background = primaryColor);
      
      const userAvatars = document.querySelectorAll('.message.user .message-avatar');
      userAvatars.forEach(avatar => avatar.style.background = secondaryColor);
      
      const userMessages = document.querySelectorAll('.message.user .message-content');
      userMessages.forEach(msg => msg.style.background = primaryColor);

      const sendButtons = document.querySelectorAll('#send-button');
      sendButtons.forEach(btn => {
        if (!btn.disabled) {
          btn.style.background = primaryColor;
        }
      });

      const allNavButtons = document.querySelectorAll('.nav-button');
      allNavButtons.forEach(btn => {
        if (btn.classList.contains('active')) {
          btn.style.background = primaryColor;
          btn.style.borderLeftColor = '#0d9488';
        } else {
          btn.style.background = 'transparent';
          btn.style.borderLeftColor = 'transparent';
        }
      });

      const activeChatRoomBtn = document.querySelector('.chat-room-item.active');
      if (activeChatRoomBtn) {
        activeChatRoomBtn.style.background = primaryColor;
      }

      const sidebarToggleBtn = document.getElementById('sidebar-toggle');
      if (sidebarToggleBtn) {
        sidebarToggleBtn.style.background = primaryColor;
      }

      const sidebarHeader = document.querySelector('.sidebar-header');
      if (sidebarHeader) sidebarHeader.style.background = primaryColor;

      const newRoomBtn = document.getElementById('new-room-btn');
      if (newRoomBtn) newRoomBtn.style.background = primaryColor;

      const createRoomBtn = document.getElementById('create-room-btn');
      if (createRoomBtn) createRoomBtn.style.background = primaryColor;

      const tableHeaders = document.querySelectorAll('.table-header');
      tableHeaders.forEach(header => header.style.background = primaryColor);

      const times = document.querySelectorAll('.table-row .time, .saved-card-title');
      times.forEach(time => time.style.color = primaryColor);

      const loadingDots = document.querySelectorAll('.loading-dots span');
      loadingDots.forEach(dot => dot.style.background = primaryColor);

      const loadingText = document.querySelector('.loading-indicator');
      if (loadingText) loadingText.style.color = primaryColor;
    }

    function mapToCapabilities(config) {
      return {
        recolorables: [
          {
            get: () => config.primary_color || defaultConfig.primary_color,
            set: (value) => {
              if (window.elementSdk) {
                window.elementSdk.setConfig({ primary_color: value });
              }
            }
          },
          {
            get: () => config.secondary_color || defaultConfig.secondary_color,
            set: (value) => {
              if (window.elementSdk) {
                window.elementSdk.setConfig({ secondary_color: value });
              }
            }
          },
          {
            get: () => config.background_color || defaultConfig.background_color,
            set: (value) => {
              if (window.elementSdk) {
                window.elementSdk.setConfig({ background_color: value });
              }
            }
          },
          {
            get: () => config.text_color || defaultConfig.text_color,
            set: (value) => {
              if (window.elementSdk) {
                window.elementSdk.setConfig({ text_color: value });
              }
            }
          },
          {
            get: () => config.white_color || defaultConfig.white_color,
            set: (value) => {
              if (window.elementSdk) {
                window.elementSdk.setConfig({ white_color: value });
              }
            }
          }
        ],
        borderables: [],
        fontEditable: undefined,
        fontSizeable: undefined
      };
    }

    function mapToEditPanelValues(config) {
      return new Map([
        ["app_title", config.app_title || defaultConfig.app_title],
        ["welcome_message", config.welcome_message || defaultConfig.welcome_message],
        ["disclaimer_text", config.disclaimer_text || defaultConfig.disclaimer_text]
      ]);
    }

    // Initialize Element SDK
    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities,
        mapToEditPanelValues
      });
    }

    // Sidebar Toggle
    const sidebar = document.getElementById('sidebar');
    const sidebarToggle = document.getElementById('sidebar-toggle');
    let isSidebarCollapsed = false;

    sidebarToggle.addEventListener('click', () => {
      isSidebarCollapsed = !isSidebarCollapsed;
      sidebar.classList.toggle('collapsed');
      sidebarToggle.textContent = isSidebarCollapsed ? '‚ñ∂' : '‚óÄ';
    });

    // Page Navigation
    function switchPage(pageName) {
      currentPage = pageName;
      
      document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active');
      });
      
      const config = window.elementSdk ? window.elementSdk.config : defaultConfig;
      const primaryColor = config.primary_color || defaultConfig.primary_color;
      
      document.querySelectorAll('.nav-button').forEach(btn => {
        btn.classList.remove('active');
        btn.style.background = 'transparent';
        btn.style.borderLeftColor = 'transparent';
        btn.style.color = '#333333';
      });

      document.getElementById(`page-${pageName}`).classList.add('active');
      const activeBtn = document.querySelector(`[data-page="${pageName}"]`);
      activeBtn.classList.add('active');
      activeBtn.style.background = primaryColor;
      activeBtn.style.borderLeftColor = '#0d9488';
      activeBtn.style.color = '#ffffff';

      // Show/hide input area based on page
      const inputArea = document.getElementById('input-area');
      if (pageName === 'chat') {
        inputArea.style.display = 'block';
      } else {
        inputArea.style.display = 'none';
      }
    }

    document.querySelectorAll('.nav-button').forEach(button => {
      button.addEventListener('click', () => {
        switchPage(button.dataset.page);
      });
    });

    // Chat Room Management
    function renderChatRooms() {
      const roomsList = document.getElementById('chat-rooms-list');
      const config = window.elementSdk ? window.elementSdk.config : defaultConfig;
      const primaryColor = config.primary_color || defaultConfig.primary_color;

      roomsList.innerHTML = chatRooms.map(room => `
        <button class="chat-room-item ${room.id === currentRoomId ? 'active' : ''}" data-room-id="${room.id}">
          <span class="chat-room-name">${room.name}</span>
          ${room.id !== 'default' ? `<span class="delete-room-btn" data-delete-room-id="${room.id}">√ó</span>` : ''}
        </button>
      `).join('');

      // Add event listeners
      roomsList.querySelectorAll('.chat-room-item').forEach(btn => {
        btn.addEventListener('click', (e) => {
          if (!e.target.classList.contains('delete-room-btn')) {
            switchChatRoom(btn.dataset.roomId);
          }
        });
      });

      roomsList.querySelectorAll('.delete-room-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          e.stopPropagation();
          await deleteRoom(btn.dataset.deleteRoomId);
        });
      });

      // Apply active color
      const activeRoomBtn = roomsList.querySelector('.chat-room-item.active');
      if (activeRoomBtn) {
        activeRoomBtn.style.background = primaryColor;
      }
    }

    function switchChatRoom(roomId) {
      currentRoomId = roomId;
      renderChatRooms();
      renderMessages();
    }

    async function deleteRoom(roomId) {
      if (roomId === currentRoomId) {
        showInlineError("Cannot delete the currently active room. Switch to another room first.");
        return;
      }

      const roomMessages = messages.filter(m => m.roomId === roomId);
      
      for (const msg of roomMessages) {
        const deleteResult = await window.dataSdk.delete(msg);
        if (!deleteResult.isOk) {
          showInlineError("Failed to delete room. Please try again.");
          return;
        }
      }
    }

    // New Room Form
    document.getElementById('new-room-btn').addEventListener('click', () => {
      const form = document.getElementById('new-room-form');
      const input = document.getElementById('new-room-input');
      form.style.display = 'block';
      input.value = '';
      input.focus();
    });

    document.getElementById('cancel-room-btn').addEventListener('click', () => {
      document.getElementById('new-room-form').style.display = 'none';
    });

    document.getElementById('create-room-btn').addEventListener('click', async () => {
      const input = document.getElementById('new-room-input');
      const roomName = input.value.trim();
      
      if (!roomName) {
        return;
      }

      if (chatRooms.length >= 20) {
        showInlineError("Maximum 20 chat rooms allowed.");
        return;
      }

      const newRoomId = 'room_' + Date.now();
      
      // Create initial message for the room
      const welcomeMsg = {
        id: newRoomId + '_welcome',
        type: 'text',
        message: `Welcome to ${roomName}! Ask me anything about health, fitness, or nutrition.`,
        sender: 'ai',
        timestamp: new Date().toISOString(),
        scheduleData: '',
        dietData: '',
        isSaved: false,
        savedType: '',
        roomId: newRoomId,
        roomName: roomName
      };

      const result = await window.dataSdk.create(welcomeMsg);
      
      if (result.isOk) {
        document.getElementById('new-room-form').style.display = 'none';
        currentRoomId = newRoomId;
      } else {
        showInlineError("Failed to create room. Please try again.");
      }
    });

    // Render messages for current room
    function renderMessages() {
      const chatArea = document.getElementById('chat-area');
      const roomMessages = messages.filter(msg => 
        (msg.roomId === currentRoomId || (!msg.roomId && currentRoomId === 'default')) &&
        msg.type !== 'saved_schedule' && 
        msg.type !== 'saved_diet'
      );
      
      const existingMessages = new Map(
        [...chatArea.querySelectorAll('.message[data-id]')].map(el => [el.dataset.id, el])
      );

      const welcomeMessage = chatArea.querySelector('.message:not([data-id])');
      
      // Clear if switching rooms
      if (roomMessages.length === 0 && existingMessages.size > 0) {
        chatArea.innerHTML = '';
        // Re-add welcome message for default room
        if (currentRoomId === 'default') {
          chatArea.innerHTML = `
            <div class="message ai">
              <div class="message-avatar">üè•</div>
              <div class="message-content">
                <div>Hello! I'm your health assistant. I can help you with:</div>
                <div style="margin-top: 8px;">
                  ‚Ä¢ Health and wellness questions<br>
                  ‚Ä¢ Creating workout schedules<br>
                  ‚Ä¢ Planning diet timetables
                </div>
                <div class="disclaimer" id="disclaimer">
                  <strong>‚ö†Ô∏è Disclaimer:</strong> <span id="disclaimer-text">${window.elementSdk ? window.elementSdk.config.disclaimer_text || defaultConfig.disclaimer_text : defaultConfig.disclaimer_text}</span>
                </div>
              </div>
            </div>
          `;
        }
        return;
      }

      roomMessages.forEach(msg => {
        if (existingMessages.has(msg.id)) {
          const existingEl = existingMessages.get(msg.id);
          const saveButton = existingEl.querySelector('.save-button');
          if (saveButton && msg.isSaved) {
            saveButton.textContent = '‚úì Saved';
            saveButton.classList.add('saved');
            saveButton.disabled = true;
          }
          existingMessages.delete(msg.id);
        } else {
          const messageEl = createMessageElement(msg);
          chatArea.appendChild(messageEl);
        }
      });

      existingMessages.forEach(el => {
        if (!el.classList.contains('message') || el.dataset.id) {
          el.remove();
        }
      });

      chatArea.scrollTop = chatArea.scrollHeight;
    }

    function createMessageElement(msg) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${msg.sender}`;
      messageDiv.dataset.id = msg.id;

      const avatar = document.createElement('div');
      avatar.className = 'message-avatar';
      avatar.textContent = msg.sender === 'ai' ? 'üè•' : 'üë§';

      const content = document.createElement('div');
      content.className = 'message-content';

      if (msg.type === 'text') {
        content.innerHTML = msg.message.replace(/\n/g, '<br>');
      } else if (msg.type === 'schedule') {
        const scheduleData = JSON.parse(msg.scheduleData);
        content.innerHTML = `
          <div>${msg.message}</div>
          <div class="schedule-table">
            <div class="table-header">Your Workout Schedule</div>
            ${scheduleData.map(item => `
              <div class="table-row">
                <div class="time">${item.time}</div>
                <div class="activity">${item.activity}</div>
              </div>
            `).join('')}
          </div>
          <button class="save-button" data-msg-id="${msg.id}" data-type="schedule">
            ${msg.isSaved ? '‚úì Saved' : 'üíæ Save to My Schedule'}
          </button>
        `;
        
        const saveBtn = content.querySelector('.save-button');
        if (msg.isSaved) {
          saveBtn.classList.add('saved');
          saveBtn.disabled = true;
        } else {
          saveBtn.addEventListener('click', () => savePlan(msg.id, 'schedule'));
        }
      } else if (msg.type === 'diet') {
        const dietData = JSON.parse(msg.dietData);
        content.innerHTML = `
          <div>${msg.message}</div>
          <div class="diet-table">
            <div class="table-header">Your Diet Plan</div>
            ${dietData.map(item => `
              <div class="table-row">
                <div class="time">${item.time}</div>
                <div class="activity">${item.meal}</div>
              </div>
            `).join('')}
          </div>
          <button class="save-button" data-msg-id="${msg.id}" data-type="diet">
            ${msg.isSaved ? '‚úì Saved' : 'üíæ Save to My Diet'}
          </button>
        `;
        
        const saveBtn = content.querySelector('.save-button');
        if (msg.isSaved) {
          saveBtn.classList.add('saved');
          saveBtn.disabled = true;
        } else {
          saveBtn.addEventListener('click', () => savePlan(msg.id, 'diet'));
        }
      }

      messageDiv.appendChild(avatar);
      messageDiv.appendChild(content);

      return messageDiv;
    }

    // Save plan function
    async function savePlan(messageId, type) {
      const message = messages.find(m => m.id === messageId);
      if (!message) return;

      const button = document.querySelector(`[data-msg-id="${messageId}"]`);
      if (button) {
        button.disabled = true;
        button.textContent = 'Saving...';
      }

      // Update the original message
      const updatedMessage = { ...message, isSaved: true };
      const updateResult = await window.dataSdk.update(updatedMessage);

      if (!updateResult.isOk) {
        showInlineError("Failed to save plan. Please try again.");
        if (button) {
          button.disabled = false;
          button.textContent = type === 'schedule' ? 'üíæ Save to My Schedule' : 'üíæ Save to My Diet';
        }
      }
    }

    // Render saved schedules
    function renderSavedSchedules() {
      const scheduleList = document.getElementById('schedule-list');
      const savedSchedules = messages.filter(m => m.type === 'schedule' && m.isSaved);

      if (savedSchedules.length === 0) {
        scheduleList.innerHTML = `
          <div class="empty-state">
            <div class="icon">üèãÔ∏è</div>
            <p>No saved workout schedules yet.<br>Create one in the chat and save it!</p>
          </div>
        `;
        return;
      }

      scheduleList.innerHTML = savedSchedules.map(msg => {
        const scheduleData = JSON.parse(msg.scheduleData);
        const date = new Date(msg.timestamp);
        return `
          <div class="saved-card" data-id="${msg.id}">
            <div class="saved-card-header">
              <div>
                <div class="saved-card-title">Workout Schedule</div>
                <div class="saved-card-date">Saved on ${date.toLocaleDateString()}</div>
              </div>
              <button class="delete-button" data-delete-id="${msg.id}">Delete</button>
            </div>
            <div class="schedule-table">
              ${scheduleData.map(item => `
                <div class="table-row">
                  <div class="time">${item.time}</div>
                  <div class="activity">${item.activity}</div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }).join('');

      scheduleList.querySelectorAll('.delete-button').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const msgId = btn.dataset.deleteId;
          await deleteSavedPlan(msgId, btn);
        });
      });
    }

    // Render saved diets
    function renderSavedDiets() {
      const dietList = document.getElementById('diet-list');
      const savedDiets = messages.filter(m => m.type === 'diet' && m.isSaved);

      if (savedDiets.length === 0) {
        dietList.innerHTML = `
          <div class="empty-state">
            <div class="icon">ü•ó</div>
            <p>No saved diet plans yet.<br>Create one in the chat and save it!</p>
          </div>
        `;
        return;
      }

      dietList.innerHTML = savedDiets.map(msg => {
        const dietData = JSON.parse(msg.dietData);
        const date = new Date(msg.timestamp);
        return `
          <div class="saved-card" data-id="${msg.id}">
            <div class="saved-card-header">
              <div>
                <div class="saved-card-title">Diet Plan</div>
                <div class="saved-card-date">Saved on ${date.toLocaleDateString()}</div>
              </div>
              <button class="delete-button" data-delete-id="${msg.id}">Delete</button>
            </div>
            <div class="diet-table">
              ${dietData.map(item => `
                <div class="table-row">
                  <div class="time">${item.time}</div>
                  <div class="activity">${item.meal}</div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }).join('');

      dietList.querySelectorAll('.delete-button').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const msgId = btn.dataset.deleteId;
          await deleteSavedPlan(msgId, btn);
        });
      });
    }

    // Delete saved plan
    async function deleteSavedPlan(messageId, button) {
      const message = messages.find(m => m.id === messageId);
      if (!message) return;

      button.disabled = true;
      button.textContent = 'Deleting...';

      const deleteResult = await window.dataSdk.delete(message);

      if (!deleteResult.isOk) {
        showInlineError("Failed to delete plan. Please try again.");
        button.disabled = false;
        button.textContent = 'Delete';
      }
    }

    // AI Response Logic
    function detectIntent(message) {
      const lowerMessage = message.toLowerCase();
      
      const scheduleKeywords = ['workout', 'exercise', 'fitness schedule', 'training plan', 'gym routine', 'workout plan', 'exercise schedule'];
      const dietKeywords = ['diet', 'meal plan', 'nutrition plan', 'eating schedule', 'food plan', 'diet plan', 'meal schedule'];

      for (const keyword of scheduleKeywords) {
        if (lowerMessage.includes(keyword)) {
          return 'schedule';
        }
      }

      for (const keyword of dietKeywords) {
        if (lowerMessage.includes(keyword)) {
          return 'diet';
        }
      }

      return 'health';
    }

    function generateHealthResponse(message) {
      const lowerMessage = message.toLowerCase();
      
      const responses = {
        sleep: "Getting 7-9 hours of quality sleep is crucial for health. Tips: maintain a consistent sleep schedule, create a dark and cool bedroom environment, avoid screens before bed, and limit caffeine after 2 PM.",
        water: "Staying hydrated is essential! Aim for 8-10 glasses of water daily. Drink more if you exercise or in hot weather. Signs of good hydration include clear or light yellow urine.",
        stress: "Managing stress is vital for health. Try: deep breathing exercises, regular physical activity, meditation, adequate sleep, talking to friends or professionals, and setting realistic goals.",
        vitamin: "A balanced diet should provide most nutrients. Focus on fruits, vegetables, whole grains, lean proteins, and healthy fats. Consult a doctor before starting supplements.",
        exercise: "Adults should aim for 150 minutes of moderate aerobic activity weekly, plus strength training twice a week. Start slowly and gradually increase intensity.",
        weight: "Healthy weight loss is typically 1-2 pounds per week through a combination of balanced diet and regular exercise. Focus on sustainable lifestyle changes rather than quick fixes.",
        default: "That's a great health question! For personalized advice, I recommend consulting with a healthcare professional. I can help you create workout schedules or diet plans - just ask!"
      };

      for (const [key, response] of Object.entries(responses)) {
        if (lowerMessage.includes(key)) {
          return response;
        }
      }

      return responses.default;
    }

    function generateSchedule() {
      const schedules = [
        [
          { time: "6:00 AM", activity: "Morning cardio - 30 min jog or brisk walk" },
          { time: "7:00 AM", activity: "Breakfast and hydration" },
          { time: "12:00 PM", activity: "Light stretching or yoga - 15 minutes" },
          { time: "6:00 PM", activity: "Strength training - Upper body focus" },
          { time: "7:30 PM", activity: "Cool down stretches" }
        ],
        [
          { time: "5:30 AM", activity: "Full body workout - 45 minutes" },
          { time: "8:00 AM", activity: "Post-workout protein meal" },
          { time: "1:00 PM", activity: "Walking break - 20 minutes" },
          { time: "7:00 PM", activity: "Evening yoga or pilates" },
          { time: "9:00 PM", activity: "Relaxation and recovery" }
        ]
      ];

      return schedules[Math.floor(Math.random() * schedules.length)];
    }

    function generateDietPlan() {
      const plans = [
        [
          { time: "7:00 AM", meal: "Oatmeal with berries and almonds" },
          { time: "10:00 AM", meal: "Greek yogurt with honey" },
          { time: "1:00 PM", meal: "Grilled chicken salad with olive oil" },
          { time: "4:00 PM", meal: "Apple slices with peanut butter" },
          { time: "7:00 PM", meal: "Baked salmon with quinoa and vegetables" },
          { time: "9:00 PM", meal: "Herbal tea" }
        ],
        [
          { time: "6:30 AM", meal: "Smoothie bowl with protein powder" },
          { time: "9:30 AM", meal: "Whole grain toast with avocado" },
          { time: "12:30 PM", meal: "Brown rice bowl with tofu and veggies" },
          { time: "3:30 PM", meal: "Mixed nuts and dried fruit" },
          { time: "6:30 PM", meal: "Lean turkey with sweet potato and broccoli" },
          { time: "8:30 PM", meal: "Chamomile tea and a small fruit" }
        ]
      ];

      return plans[Math.floor(Math.random() * plans.length)];
    }

  async function processMessage(userMessage) {
    const messageId = Date.now().toString() + Math.random().toString(36).substr(2, 9);

    // ÂèñÁï∂Ââç room Âêç
    const currentRoom = chatRooms.find(r => r.id === currentRoomId);
    const roomName = currentRoom ? currentRoom.name : 'General Health';

    // üß† 1Ô∏è‚É£ ÂÖàÊ†πÊìöÁèæÊúâ messagesÔºåÊäΩÂá∫„ÄåÂë¢ÂÄãÊàøÊúÄËøë N Ê¢ùÂ∞çË©±„ÄçÂÅö history
    // Ê≥®ÊÑèÔºöÂë¢Â∫¶Âè™Áî®„Äå‰πãÂâçÂòÖÂ∞çË©±„ÄçÔºåÂîîÂåÖ‰ªäÊ¨° user Âë¢Âè•Ôºà‰ªäÊ¨°ÊúÉÂÖ•ÂéªÊúÄÂæåÂÄã user messageÔºâ
    const roomHistoryMessages = messages
      .filter(m =>
        (m.roomId === currentRoomId || (!m.roomId && currentRoomId === 'default')) &&
        (m.sender === 'user' || m.sender === 'ai') &&
        (m.type === 'text')  // schedule / diet Âç°Êúâ message Â≠óÔºåÂÖ∂ÂØ¶ÈÉΩÂèØ‰ª•Ôºå‰ΩÜ prototype ÂÖàÁî® text Â∑≤Á∂ìÂ§†
      )
      .slice(-10) // ÊúÄËøë 10 Ê¢ù
      .map(m => ({
        role: m.sender === 'user' ? 'user' : 'assistant',
        content: m.message || ''
      }));

    // 2Ô∏è‚É£ ÁÖßËàäÔºöÂÖàÂ≠ò user message ËêΩ Data SDK
    await window.dataSdk.create({
      id: messageId + '_user',
      type: 'text',
      message: userMessage,
      sender: 'user',
      timestamp: new Date().toISOString(),
      scheduleData: '',
      dietData: '',
      isSaved: false,
      savedType: '',
      roomId: currentRoomId,
      roomName: roomName
    });

    try {
      // 3Ô∏è‚É£ Call backend /api/chatÔºåÂä†Âüã history ÊØîÂæåÁ´Ø / LLM Áî®
      const response = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          roomId: currentRoomId,
          roomName,
          message: userMessage,
          history: roomHistoryMessages   // üëà ‰æùÂÆ∂Â§öÂíóÂë¢ÂÄã
        })
      });

      const data = await response.json();

      // 4Ô∏è‚É£ ÁµÑË£ù AI messageÔºàÂêå‰Ω†ÂéüÊú¨‰∏ÄÊ®£Ôºâ
      const aiMsg = {
        id: messageId + '_ai',
        type: data.type || 'text',      // "text" / "schedule" / "diet"
        message: data.message || '',
        sender: 'ai',
        timestamp: new Date().toISOString(),
        scheduleData: data.scheduleData
          ? JSON.stringify(data.scheduleData)
          : '',
        dietData: data.dietData
          ? JSON.stringify(data.dietData)
          : '',
        isSaved: false,
        savedType:
          data.type === 'schedule'
            ? 'schedule'
            : data.type === 'diet'
            ? 'diet'
            : '',
        roomId: currentRoomId,
        roomName: roomName
      };

      await window.dataSdk.create(aiMsg);
    } catch (err) {
      console.error('Error calling /api/chat:', err);
      await window.dataSdk.create({
        id: messageId + '_error',
        type: 'text',
        message: '‚ö†Ô∏è Sorry, there was an error connecting to the AI server.',
        sender: 'ai',
        timestamp: new Date().toISOString(),
        scheduleData: '',
        dietData: '',
        isSaved: false,
        savedType: '',
        roomId: currentRoomId,
        roomName: roomName
      });
    }
  }



    function showInlineError(message) {
      const chatArea = document.getElementById('chat-area');
      const errorDiv = document.createElement('div');
      errorDiv.className = 'message ai';
      errorDiv.innerHTML = `
        <div class="message-avatar">‚ö†Ô∏è</div>
        <div class="message-content" style="background: #ffebee; color: #c62828; border-color: #ef5350;">
          ${message}
        </div>
      `;
      chatArea.appendChild(errorDiv);
      chatArea.scrollTop = chatArea.scrollHeight;

      setTimeout(() => errorDiv.remove(), 5000);
    }

    // Form submission
    document.getElementById('message-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      if (isProcessing) return;

      const input = document.getElementById('message-input');
      const sendButton = document.getElementById('send-button');
      const loadingIndicator = document.getElementById('loading-indicator');
      const message = input.value.trim();

      if (!message) return;

      if (messages.length >= 999) {
        showInlineError("Message limit reached (999 messages). Please start a new conversation.");
        return;
      }

      isProcessing = true;
      input.disabled = true;
      sendButton.disabled = true;
      loadingIndicator.classList.add('active');
      input.value = '';

      await new Promise(resolve => setTimeout(resolve, 800));

      await processMessage(message);

      isProcessing = false;
      input.disabled = false;
      sendButton.disabled = false;
      loadingIndicator.classList.remove('active');
      input.focus();
    });

    // Initialize
    initDataSdk();
  </script>
 </body>
</html>