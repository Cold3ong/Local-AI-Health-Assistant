// server.js
import express from "express";
import path from "path";
import { fileURLToPath } from "url";
import OpenAI from "openai";

const app = express();
const port = 3000;

// ---------------- LM Studio as OpenAI-compatible server ----------------
const client = new OpenAI({
  baseURL: "http://127.0.0.1:1234/v1", // LM Studio OpenAI serverï¼Œä¸€å®šè¦æœ‰ /v1
  apiKey: "not-needed",                // LM Studio å”” checkï¼Œä½† SDK éœ€è¦å€‹å€¼
});

// å–å¾— __dirnameï¼ˆå› ç‚ºç”¨ ES moduleï¼‰
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// éœæ…‹æª”æ¡ˆï¼ˆå‰ç«¯ï¼‰
app.use(express.static(path.join(__dirname, "public")));
app.use(express.json());

// ---------------- Tools / Functions å®šç¾© ----------------

// 1) çœŸæ­£åŸ·è¡Œå˜… JS functionï¼šæ”žç³»çµ±æ™‚é–“
function getCurrentTime() {
  const now = new Date();
  return {
    iso: now.toISOString(),
    locale: now.toLocaleString(), // æ ¹æ“š server æ‰€åœ¨åœ°
  };
}

// 2) ðŸ†• JS functionï¼šé©—è­‰ç”± AI å¡«å…¥å˜… planï¼ˆAI ç”Ÿæˆå…§å®¹ï¼Œå‘¢åº¦åªä¿‚åš JSON æ½”æ·¨ / é™åˆ¶ï¼‰
//    args.plan æ‡‰è©²ä¿‚ä¸€å€‹ arrayï¼Œæ¯å€‹ item è‡³å°‘æœ‰ time / activity
function createWorkoutPlanTool(args = {}) {
  const rawPlan = Array.isArray(args.plan) ? args.plan : [];
  const plan = [];

  for (const item of rawPlan) {
    if (!item || typeof item !== "object") continue;

    let { time, activity, durationMinutes } = item;

    if (typeof time !== "string" || typeof activity !== "string") {
      continue; // å””åˆè¦å°± skip
    }

    // åšå°‘å°‘æ¸…ç†ï¼Œé¿å…å¤ªé•·å…§å®¹
    time = time.slice(0, 100);
    activity = activity.slice(0, 300);

    const cleaned = { time, activity };

    if (
      typeof durationMinutes === "number" &&
      durationMinutes > 0 &&
      durationMinutes < 300
    ) {
      cleaned.durationMinutes = durationMinutes;
    }

    plan.push(cleaned);
  }

  // å¦‚æžœ AI ç”Ÿæˆå®Œå…¨å””åˆè¦ï¼Œå°±å›žç©ºé™£åˆ—
  if (plan.length === 0) {
    return { plan: [] };
  }

  // é˜²æ­¢å¤ªé•·ï¼ˆé¿å…å‰ç«¯çˆ† UIï¼‰
  if (plan.length > 40) {
    plan.length = 40;
  }

  return { plan };
}


// Tool schemaï¼ˆæ¯” LM Studio / model ç‡ï¼‰
// ç¾åœ¨æœ‰å…©å€‹ toolsï¼šgetCurrentTime + createWorkoutPlan
const tools = [
  {
    type: "function",
    function: {
      name: "getCurrentTime",
      description: "Get the current local time of the server.",
      parameters: {
        type: "object",
        properties: {},
        additionalProperties: false,
      },
    },
  },
  {
    type: "function",
    function: {
      name: "createWorkoutPlan",
      description:
        "Create a full workout schedule. The model must generate the complete plan inside the 'plan' array before calling this tool.",
      parameters: {
        type: "object",
        properties: {
          plan: {
            type: "array",
            description:
              "The full workout schedule generated by the model. Each item represents one step in the schedule.",
            items: {
              type: "object",
              properties: {
                time: {
                  type: "string",
                  description: "Time label, e.g. '8:00 AM' or 'Day 1 - Morning'.",
                },
                activity: {
                  type: "string",
                  description: "Workout description or instructions.",
                },
                durationMinutes: {
                  type: "integer",
                  description:
                    "Optional estimated duration in minutes for this activity.",
                },
              },
              required: ["time", "activity"],
              additionalProperties: false,
            },
          },
        },
        required: ["plan"],
        additionalProperties: false,
      },
    },
  },
];

// ---------------- Chat endpoint ----------------

app.post("/api/chat", async (req, res) => {
  try {
    const userMessage = req.body.message || "";
    const roomName = req.body.roomName || "General Health";

    const baseMessages = [
      {
        role: "system",
        content:
          "You are a friendly Cantonese-speaking health assistant. " +
          "Reply mainly in Cantonese, but keep health/fitness terms in English when appropriate. " +
          //"You MUST always remind users that you are not a doctor and they should consult professionals for medical concerns. " +
          "If the user asks about the current time / now / å¹¾é»ž, you SHOULD use the getCurrentTime tool. " +
          "If the user asks for a workout schedule, exercise plan, gym routine, æˆ–è€…ã€Žå¹«æˆ‘æ•´é‹å‹•æ™‚é–“è¡¨ã€ï¼Œ" +
          "YOU MUST first design a complete workout timetable in your mind, then call the createWorkoutPlan tool " +
          "by filling the 'plan' array with JSON objects: { time, activity, durationMinutes? }. " +
          "Make sure to include any specific constraints the user asked for, such as '12:00 PM 30-min yoga'. " +
          `The current chat room name is: "${roomName}", use it only as soft context about their goal.`,
      },
      { role: "user", content: userMessage },
    ];


    // 1ï¸âƒ£ ç¬¬ä¸€æ¬¡ call LM Studioï¼šç­‰ä½¢æ±ºå®šç”¨å””ç”¨ tools
    const first = await client.chat.completions.create({
      model: "nousresearch-hermes-2-pro-llama-3-8b-molecule16-i1",
      messages: baseMessages,
      tools,
      tool_choice: "auto",
    });

    console.log(
      "First response from LM Studio:",
      JSON.stringify(first, null, 2),
    );

    if (!first.choices || first.choices.length === 0) {
      return res.status(500).json({
        type: "text",
        message: "å°å””ä½ï¼ŒAI å†‡æ­£å¸¸å›žæ‡‰ã€‚",
        scheduleData: null,
        dietData: null,
        usedTool: false,
        raw: first,
      });
    }

    const firstMsg = first.choices[0].message;
    const toolCalls = firstMsg.tool_calls;

    // å¦‚æžœå†‡ç”¨ä»»ä½• tool â†’ æ™®é€šæ–‡å­—å›žç­”
    if (!toolCalls || toolCalls.length === 0) {
      return res.json({
        type: "text",
        message: firstMsg.content,
        scheduleData: null,
        dietData: null,
        usedTool: false,
      });
    }

    // æƒ…æ³ Bï¼šç”¨å’— toolsï¼Œæˆ‘å“‹é€å€‹åŸ·è¡Œï¼Œä¸¦ä¸”æ”¶é›† scheduleDataï¼ˆä¿¾å‰ç«¯ç•«å¡ï¼‰
    const toolMessages = [];
    let scheduleData = null; // ç”¨ä¾†å›žä¿¾å‰ç«¯å˜… workout scheduleï¼ˆå¦‚æžœæœ‰ï¼‰

    for (const call of toolCalls) {
      const toolName = call.function.name;
      let toolResult = null;

      // å°‡ arguments ç”± JSON string è®Šæˆ JS object
      let args = {};
      try {
        args = call.function.arguments
          ? JSON.parse(call.function.arguments)
          : {};
      } catch (e) {
        console.warn("Failed to parse tool arguments:", e);
      }

      if (toolName === "getCurrentTime") {
        toolResult = getCurrentTime();
      } else if (toolName === "createWorkoutPlan") {
        // args.plan ç”± AI ç”Ÿæˆï¼Œå‘¢åº¦åš validationï¼‹æ¸…ç†
        const { plan } = createWorkoutPlanTool(args);
        toolResult = { plan };
        scheduleData = plan; // scheduleData ä¿¾å‰ç«¯ç•¶ä½œ schedule card ç”¨
      } else {
        toolResult = { error: `Unknown tool: ${toolName}` };
      }

      toolMessages.push({
        role: "tool",
        tool_call_id: call.id,
        name: toolName,
        content: JSON.stringify(toolResult),
      });
    }

    // 2ï¸âƒ£ ç¬¬äºŒæ¬¡ call LM Studioï¼šç•€ tool çµæžœï¼Œå«ä½¢ç”¨è‡ªç„¶èªžè¨€è¬›è¿”
    const second = await client.chat.completions.create({
      model: "nousresearch-hermes-2-pro-llama-3-8b-molecule16-i1",
      messages: [...baseMessages, firstMsg, ...toolMessages],
    });

    console.log(
      "Second response from LM Studio:",
      JSON.stringify(second, null, 2),
    );

    if (!second.choices || second.choices.length === 0) {
      return res.status(500).json({
        type: "text",
        message: "å°å””ä½ï¼ŒAI å–ºè™•ç†å·¥å…·çµæžœæ™‚å‡ºç¾å’—å•é¡Œã€‚",
        scheduleData,
        dietData: null,
        usedTool: true,
        raw: second,
      });
    }

    const finalMsg = second.choices[0].message;

    // å¦‚æžœæœ‰ scheduleData â†’ ç•¶ä½œ schedule messageï¼Œä¿¾å‰ç«¯ç•« workout card
    const responseType = scheduleData ? "schedule" : "text";

    res.json({
      type: responseType,        // "schedule" æˆ– "text"
      message: finalMsg.content, // AI ç”¨è‡ªç„¶èªžè¨€è¬›è¿” result
      scheduleData: scheduleData,
      dietData: null,            // ä¹‹å¾Œä½ å¯ä»¥åŠ  createDietPlan æ™‚ç”¨
      usedTool: true,
    });
  } catch (err) {
    console.error("Error in /api/chat:", err);
    res.status(500).json({
      type: "text",
      message: "Server errorï¼Œè«‹ç¨å¾Œå†è©¦ã€‚",
      scheduleData: null,
      dietData: null,
      usedTool: false,
      detail: String(err),
    });
  }
});

// å•Ÿå‹• server
app.listen(port, () => {
  console.log(`Server running at http://localhost:${port}`);
});
