// server.js
import express from "express";
import path from "path";
import { fileURLToPath } from "url";
import OpenAI from "openai";

const app = express();
const port = 3000;

// ---------------- LM Studio as OpenAI-compatible server ----------------
const client = new OpenAI({
  baseURL: "http://127.0.0.1:1234/v1", // LM Studio OpenAI serverï¼Œä¸€å®šè¦æœ‰ /v1
  apiKey: "not-needed",                // LM Studio å”” checkï¼Œä½† SDK éœ€è¦å€‹å€¼
});

// å–å¾— __dirnameï¼ˆå› ç‚ºç”¨ ES moduleï¼‰
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// éœæ…‹æª”æ¡ˆï¼ˆå‰ç«¯ï¼‰
app.use(express.static(path.join(__dirname, "public")));
app.use(express.json());

// ---------------- Tools / Functions å®šç¾© ----------------

// 1) æ”žç³»çµ±æ™‚é–“
function getCurrentTime() {
  const now = new Date();
  return {
    iso: now.toISOString(),
    locale: now.toLocaleString(), // æ ¹æ“š server æ‰€åœ¨åœ°
  };
}

// 2) Workout Plan Validator
//    AI æœƒå–º arguments.plan å…¥é¢å¡žå¥½æ•´ä»½ timetableï¼Œå‘¢åº¦æ·¨ä¿‚åš JSON validation / æ¸…ç†
function createWorkoutPlanTool(args = {}) {
  const rawPlan = Array.isArray(args.plan) ? args.plan : [];
  const plan = [];

  for (const item of rawPlan) {
    if (!item || typeof item !== "object") continue;

    let { time, activity, durationMinutes } = item;

    if (typeof time !== "string" || typeof activity !== "string") {
      continue; // å””åˆè¦å°± skip
    }

    // ç°¡å–®é˜²æ­¢å¤ªé•·æ–‡å­—
    time = time.slice(0, 100);
    activity = activity.slice(0, 300);

    const cleaned = { time, activity };

    if (
      typeof durationMinutes === "number" &&
      durationMinutes > 0 &&
      durationMinutes < 300
    ) {
      cleaned.durationMinutes = durationMinutes;
    }

    plan.push(cleaned);
  }

  if (plan.length === 0) {
    return { plan: [] };
  }

  // é˜²æ­¢ AI ç”Ÿå¤ªå¤šè¡Œæžåˆ° UI çˆ†
  if (plan.length > 40) {
    plan.length = 40;
  }

  return { plan };
}

// 3) ðŸ†• Diet Plan Validator
//    åŒæ¨£åœ°ï¼ŒAI æœƒå–º arguments.plan å…¥é¢å¡žå¥½å®Œæ•´ diet timetable
//    æ¯ä¸€è¡Œè‡³å°‘è¦æœ‰ time + mealï¼›caloriesEstimate ä¿‚ optional
function createDietPlanTool(args = {}) {
  const rawPlan = Array.isArray(args.plan) ? args.plan : [];
  const plan = [];

  for (const item of rawPlan) {
    if (!item || typeof item !== "object") continue;

    let { time, meal, caloriesEstimate } = item;

    if (typeof time !== "string" || typeof meal !== "string") {
      continue;
    }

    time = time.slice(0, 100);
    meal = meal.slice(0, 300);

    const cleaned = { time, meal };

    if (
      typeof caloriesEstimate === "number" &&
      caloriesEstimate > 0 &&
      caloriesEstimate < 5000
    ) {
      cleaned.caloriesEstimate = caloriesEstimate;
    }

    plan.push(cleaned);
  }

  if (plan.length === 0) {
    return { plan: [] };
  }

  if (plan.length > 40) {
    plan.length = 40;
  }

  return { plan };
}

// Tool schemaï¼ˆæ¯” LM Studio / model ç‡ï¼‰
// æœ‰ä¸‰å€‹ toolsï¼šgetCurrentTime + createWorkoutPlan + createDietPlan
const tools = [
  {
    type: "function",
    function: {
      name: "getCurrentTime",
      description: "Get the current local time of the server.",
      parameters: {
        type: "object",
        properties: {},
        additionalProperties: false,
      },
    },
  },
  {
    type: "function",
    function: {
      name: "createWorkoutPlan",
      description:
        "Create a full workout schedule. The model must generate the complete plan inside the 'plan' array before calling this tool.",
      parameters: {
        type: "object",
        properties: {
          plan: {
            type: "array",
            description:
              "The full workout schedule generated by the model. Each item represents one step in the schedule.",
            items: {
              type: "object",
              properties: {
                time: {
                  type: "string",
                  description:
                    "Time label, e.g. '8:00 AM' or 'Day 1 - Morning'.",
                },
                activity: {
                  type: "string",
                  description: "Workout description or instructions.",
                },
                durationMinutes: {
                  type: "integer",
                  description:
                    "Optional estimated duration in minutes for this activity.",
                },
              },
              required: ["time", "activity"],
              additionalProperties: false,
            },
          },
        },
        required: ["plan"],
        additionalProperties: false,
      },
    },
  },
  {
    type: "function",
    function: {
      name: "createDietPlan",
      description:
        "Create a full diet / meal plan. The model must generate the complete plan inside the 'plan' array before calling this tool.",
      parameters: {
        type: "object",
        properties: {
          plan: {
            type: "array",
            description:
              "The full diet plan generated by the model. Each item represents one eating occasion.",
            items: {
              type: "object",
              properties: {
                time: {
                  type: "string",
                  description:
                    "Time label, e.g. '7:00 AM - Breakfast' or 'Lunch'.",
                },
                meal: {
                  type: "string",
                  description:
                    "Meal description, e.g. 'Oatmeal with berries and nuts'.",
                },
                caloriesEstimate: {
                  type: "integer",
                  description:
                    "Optional rough calorie estimate for this meal (in kcal).",
                },
              },
              required: ["time", "meal"],
              additionalProperties: false,
            },
          },
        },
        required: ["plan"],
        additionalProperties: false,
      },
    },
  },
];

// ---------------- Chat endpoint ----------------

app.post("/api/chat", async (req, res) => {
  try {
    const userMessage = req.body.message || "";
    const roomName = req.body.roomName || "General Health";
    const history = Array.isArray(req.body.history) ? req.body.history : [];

    const baseMessages = [
      {
        role: "system",
        content:
          "You are a friendly Cantonese-speaking health assistant. " +
          "Reply mainly in Cantonese, but keep health/fitness and nutrition terms in English when appropriate. " +
          "You MUST always remind users that you are not a doctor or dietitian. " +
          "If the user asks for a workout schedule, YOU MUST generate the full plan in the 'plan' array, then call createWorkoutPlan. " +
          "If the user asks for a diet plan, YOU MUST generate the full plan in the 'plan' array, then call createDietPlan. " +
          "Include all user constraints when generating the plan. " +
          "You MUST understand and use the conversation history to improve responses. " +
          `The current chat room name is: "${roomName}".`
      },

      // ðŸ§  åŠ å…¥ chatroom éŽåŽ» N å¥æ­·å²å°è©±
      ...history,

      // æœ€æ–° user å‘¢å¥æ”¾æœ€å¾Œ
      { role: "user", content: userMessage },
    ];


    // 1ï¸âƒ£ ç¬¬ä¸€æ¬¡ call LM Studioï¼šç­‰ä½¢æ±ºå®šç”¨å””ç”¨ tools
    const first = await client.chat.completions.create({
      model: "nousresearch-hermes-2-pro-llama-3-8b-molecule16-i1",
      messages: baseMessages,
      tools,
      tool_choice: "auto",
    });

    console.log(
      "First response from LM Studio:",
      JSON.stringify(first, null, 2),
    );

    if (!first.choices || first.choices.length === 0) {
      return res.status(500).json({
        type: "text",
        message: "å°å””ä½ï¼ŒAI å†‡æ­£å¸¸å›žæ‡‰ã€‚",
        scheduleData: null,
        dietData: null,
        usedTool: false,
        raw: first,
      });
    }

    const firstMsg = first.choices[0].message;
    const toolCalls = firstMsg.tool_calls;

    // å¦‚æžœå†‡ç”¨ä»»ä½• tool â†’ æ™®é€šæ–‡å­—å›žç­”
    if (!toolCalls || toolCalls.length === 0) {
      return res.json({
        type: "text",
        message: firstMsg.content,
        scheduleData: null,
        dietData: null,
        usedTool: false,
      });
    }

    // æƒ…æ³ Bï¼šç”¨å’— toolsï¼Œæˆ‘å“‹é€å€‹åŸ·è¡Œï¼Œæ”¶é›† scheduleData / dietData ä¿¾å‰ç«¯ç•«å¡
    const toolMessages = [];
    let scheduleData = null;
    let dietData = null;

    for (const call of toolCalls) {
      const toolName = call.function.name;
      let toolResult = null;

      // å°‡ arguments ç”± JSON string è®Šæˆ JS object
      let args = {};
      try {
        args = call.function.arguments
          ? JSON.parse(call.function.arguments)
          : {};
      } catch (e) {
        console.warn("Failed to parse tool arguments:", e);
      }

      if (toolName === "getCurrentTime") {
        toolResult = getCurrentTime();
      } else if (toolName === "createWorkoutPlan") {
        const { plan } = createWorkoutPlanTool(args);
        toolResult = { plan };
        scheduleData = plan;
      } else if (toolName === "createDietPlan") {
        const { plan } = createDietPlanTool(args);
        toolResult = { plan };
        dietData = plan;
      } else {
        toolResult = { error: `Unknown tool: ${toolName}` };
      }

      toolMessages.push({
        role: "tool",
        tool_call_id: call.id,
        name: toolName,
        content: JSON.stringify(toolResult),
      });
    }

    // 2ï¸âƒ£ ç¬¬äºŒæ¬¡ call LM Studioï¼šç•€ tool çµæžœï¼Œå«ä½¢ç”¨è‡ªç„¶èªžè¨€è¬›è¿”
    const second = await client.chat.completions.create({
      model: "nousresearch-hermes-2-pro-llama-3-8b-molecule16-i1",
      messages: [...baseMessages, firstMsg, ...toolMessages],
    });

    console.log(
      "Second response from LM Studio:",
      JSON.stringify(second, null, 2),
    );

    if (!second.choices || second.choices.length === 0) {
      return res.status(500).json({
        type: "text",
        message: "å°å””ä½ï¼ŒAI å–ºè™•ç†å·¥å…·çµæžœæ™‚å‡ºç¾å’—å•é¡Œã€‚",
        scheduleData,
        dietData,
        usedTool: true,
        raw: second,
      });
    }

    const finalMsg = second.choices[0].message;

    // å¦‚æžœæœ‰ dietData â†’ å„ªå…ˆç•¶ diet cardï¼›
    // å…¶æ¬¡å¦‚æžœæœ‰ scheduleData â†’ ç•¶ workout cardï¼›
    // å¦å‰‡ç•¶æ™®é€š text
    let responseType = "text";
    if (dietData && dietData.length > 0) {
      responseType = "diet";
    } else if (scheduleData && scheduleData.length > 0) {
      responseType = "schedule";
    }

    res.json({
      type: responseType,        // "diet" / "schedule" / "text"
      message: finalMsg.content, // AI ç”¨è‡ªç„¶èªžè¨€è¬›è¿” result
      scheduleData: scheduleData,
      dietData: dietData,
      usedTool: true,
    });
  } catch (err) {
    console.error("Error in /api/chat:", err);
    res.status(500).json({
      type: "text",
      message: "Server errorï¼Œè«‹ç¨å¾Œå†è©¦ã€‚",
      scheduleData: null,
      dietData: null,
      usedTool: false,
      detail: String(err),
    });
  }
});

// å•Ÿå‹• server
app.listen(port, () => {
  console.log(`Server running at http://localhost:${port}`);
});
